---
title: "p8105_hw5_qz2527"
author: "kindle zhang"
date: "2023-11-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## Problem 1


* first we import the data and describe it concisely.

```{r}
homi_data = read_csv("./data_file/homicide-data.csv")

head(homi_data, 5)
summary(homi_data)
```

<font color = red>This is a dataset with a `r homi_data |> nrow()`rows and a `r homi_data |> ncol()` variables. It includes the homicides events' details, like victim's name, report date, the location where the accident occures and so on.</font>

* tidy the data and make a series of operation upon it

```{r}
homi_data =
  homi_data |>
  janitor::clean_names() |>
  mutate(city_state = str_c(city, ", ", state))

homi_by_city =
  homi_data |>
  drop_na(disposition) |> 
  group_by(city_state) |>
  mutate(
    unsolved_homi = case_match(
      disposition,
      "Closed without arrest" ~ 1,
      "Open/No arrest" ~ 1,
      .default = 0
    )
  ) |>
  summarise(total_homi = n(),
            unsolved_homi = sum(unsolved_homi))

homi_by_city
```

<font color = red>according to the result gained above , we can summarize the total homicides and unsolved homicides by each city.</font>

* use `prop.test` function to estimate the proportion of homicides that are unsolved

```{r}
homi_Bal = 
  homi_by_city |> 
    filter(city_state == "Baltimore, MD") 

result_Bal = 
  prop.test(
    x = homi_Bal$"unsolved_homi",
    n = homi_Bal$"total_homi",
    p = NULL,
    alternative = "two.sided"
  )

result_Bal |> 
  broom::tidy() |> 
  select(estimate, conf.low, conf.high) |> 
  rename(esti_prop = estimate)
```

* loop the function for each city

```{r, warning = FALSE}
prop_by_city = 
  homi_by_city |>
    mutate(prop_test_result =
             map2(unsolved_homi,
                  total_homi,
                  ~ prop.test(x = .x, n = .y))) |>
    mutate(estimate_result =
             map(prop_test_result, broom::tidy)) |>
    unnest(estimate_result) |>
    select(city_state, estimate, conf.low, conf.high)

head(prop_by_city)
```

* create a plot

```{r}
plot =
  prop_by_city |>
  mutate(city_state = fct_reorder(city_state, estimate)) |>
  ggplot(aes(x = city_state, y = estimate)) + geom_point(color = "yellow",
                                                         size = 3,
                                                         alpha = .4) + geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
                                                                                     width = .2,
                                                                                     color = "blue") + coord_flip() +
  theme_classic()+
  labs(title = "Proportiton of Unsolved Homicides by City",
       x = "City",
       y = "Estimated Proportion of Unsolved Homicides")

plot
```

## Problem 2

* import the data by using the function `list.files`, and then tidy it.

```{r, message=FALSE}
path = "./data_file/problem_2"
id = list.files(path)
id_list = as.list(id)

new_df =
  tibble(id = id_list) |>
  mutate(address = str_c(path , "/", id),
         weekly_data = map(address, read_csv)) |>
  separate(id, into = c("arm", "other"), sep = "_") |>
  separate(other, into = c("id", "other"), sep = 2) |>
  select(-other,-address) |>
  unnest(weekly_data)
```

* show the dataset

```{r}
new_df |>
  knitr::kable()
```

* make a spaghetti plot showing observations on each subject over time

```{r}
new_df = 
  new_df |> 
    mutate(arm_id = str_c(arm, "_", id)) |> 
    select( -id) |> 
    relocate(arm_id) |> 
  pivot_longer(
    week_1:week_8,
    names_to = "time",
    values_to = "data"
  ) 

plot_2 = 
  new_df |> 
  separate(time, into = c("week", "time"), sep = 5)|>
  mutate(time = as.numeric(time)) |> 
  ggplot(aes(x = time, y = data, color = arm_id)) + geom_line() + 
  facet_grid(. ~ arm) + 
  labs(
    title = "A “spaghetti” plot",
    x = "time(week)",
    y = "data_value",
    color = "State",
    caption = "data_value over time"
  )+
  theme(legend.position = "bottom")
  
plot_2
```

<font color = red>We can find that the data in the control group swings in a range of -2.5 to 4 stably. The trend in the experiment group is climbing from the zero to the 7.5. </font>

## Problem 3 
  
